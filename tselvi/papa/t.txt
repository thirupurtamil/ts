from django.shortcuts import render
from django.shortcuts import render 
from django.http import HttpResponse
import datetime 
import platform 
from django.contrib.auth import get_user_model
from django.contrib.auth.models import User
from django.contrib.auth.decorators import login_required
from django.views.generic import ListView, DetailView, View
from django.utils import timezone
from django.conf import settings
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.contrib.auth.mixins import LoginRequiredMixin
from django.core.exceptions import ObjectDoesNotExist
import os
import sys
from django.views.generic import TemplateView, ListView, CreateView
from django.core.files.storage import FileSystemStorage
from django.urls import reverse_lazy
from django.shortcuts import render, redirect

from django.contrib.auth.decorators import login_required

from django.contrib import messages

from django.shortcuts import get_object_or_404

from django.http import JsonResponse

from django.views.decorators.http import require_POST

from django.http import HttpResponse

from django.core.paginator import Paginator, EmptyPage, \

                                  PageNotAnInteger

from .forms import ImageCreateForm

from .models import Image




# Create your views here.



def home(request):
    return render (request,'papa/home.html',{})

def tss(request):
    msg = 'HAI'
    name = 'TAMIL'
    User = get_user_model()
    count= User.objects.count
    date = datetime.datetime.now()
    hour = int(date.strftime('%H'))
    if hour<12:
     msg+=  ',GOOD MORNING'
    else:
     msg+=  ',GOOD EVENING'
    
    date_dict = {'index_date':date ,'empname':name , 'greetings':msg, 'count':count , }
    return render (request,'papa/pa.html',context =date_dict)





@login_required

def image_create(request):

    if request.method == 'POST':

        # form is sent

        form = ImageCreateForm(data=request.POST)

        if form.is_valid():

            # form data is valid

            cd = form.cleaned_data

            new_image = form.save(commit=False)

            # assign current user to the item

            new_image.user = request.user

            new_image.save()

            messages.success(request, 'Image added successfully')

            # redirect to new created image detail view

            return redirect(new_image.get_absolute_url())

    else:

        # build form with data provided by the bookmarklet via GET

        form = ImageCreateForm(data=request.GET)

    return render(request,

                  'images/image/create.html',

                  {'section': 'images',

                   'form': form})

def image_detail(request, id, slug):

    image = get_object_or_404(Image, id=id, slug=slug)

    return render(request,

                  'images/image/detail.html',

                  {'section': 'images',

                   'image': image})

@login_required

@require_POST

def image_like(request):

    image_id = request.POST.get('id')

    action = request.POST.get('action')

    if image_id and action:

        try:

            image = Image.objects.get(id=image_id)

            if action == 'like':

                image.users_like.add(request.user)

            else:

                image.users_like.remove(request.user)

            return JsonResponse({'status': 'ok'})

        except Image.DoesNotExist:

            pass

    return JsonResponse({'status': 'error'})

@login_required

def image_list(request):

    images = Image.objects.all()

    paginator = Paginator(images, 8)

    page = request.GET.get('page')

    images_only = request.GET.get('images_only')

    try:

        images = paginator.page(page)

    except PageNotAnInteger:

        # If page is not an integer deliver the first page

        images = paginator.page(1)

    except EmptyPage:

        if images_only:

            # If AJAX request and page out of range

            # return an empty page

            return HttpResponse('')

        # If page out of range return last page of results

        images = paginator.page(paginator.num_pages)

    if images_only:

        return render(request,

                      'images/image/list_images.html',

                      {'section': 'images',

                       'images': images})

    return render(request,

                  'images/image/list.html',

                   {'section': 'images',

                    'images': images})

