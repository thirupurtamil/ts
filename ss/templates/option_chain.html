{% extends 'layout.html' %}
{% block title %}ğŸ“Š NIFTY 50 Option Chain{% endblock %}

{% block content %}
  <h1>ğŸ“Š NIFTY 50 Option Chain</h1>

  <div class="stats text-center mb-3" id="statsArea">
    <div class="stat-card">
      <div class="stat-label">Expiry</div>
      <div class="stat-value" id="expiry">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Spot</div>
      <div class="stat-value" id="spot">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ğŸ“ˆ Call Max Chg OI</div>
      <div class="stat-value" id="callMax">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ğŸ“‰ Put Max Chg OI</div>
      <div class="stat-value" id="putMax">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ğŸŸ¡ Call Min Chg OI</div>
      <div class="stat-value" id="callMin">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ğŸ”µ Put Min Chg OI</div>
      <div class="stat-value" id="putMin">--</div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle" id="optionTable"></table>
  </div>

  <div class="record-count">Showing Â±10 strikes around ATM</div>

  <button class="refresh-btn" onclick="fetchOptionChain()">ğŸ”„ Refresh Data</button>

  <script>
    async function fetchOptionChain() {
      const expiryEl = document.getElementById("expiry");
      const spotEl = document.getElementById("spot");
      const callMaxEl = document.getElementById("callMax");
      const putMaxEl = document.getElementById("putMax");
      const callMinEl = document.getElementById("callMin");
      const putMinEl = document.getElementById("putMin");
      const table = document.getElementById("optionTable");

      expiryEl.innerText = "â³";
      spotEl.innerText = "Loading...";
      table.innerHTML = "";

      try {
        const res = await fetch("/api/option_chain/");
        const data = await res.json();

        if (!res.ok) throw new Error(data.message || "Data load error");

        expiryEl.innerText = data.expiry;
        spotEl.innerText = data.spot;
        callMaxEl.innerText = data.call_max_strike;
        putMaxEl.innerText = data.put_max_strike;
        callMinEl.innerText = data.call_min_strike;
        putMinEl.innerText = data.put_min_strike;

        const columns = Object.keys(data.option_chain[0]);
        let header = "<thead><tr>";
        columns.forEach(col => header += `<th>${col}</th>`);
        header += "</tr></thead>";

        let body = "<tbody>";
        data.option_chain.forEach(row => {
          body += "<tr>";
          columns.forEach(col => {
            const value = row[col];
            let cls = "";
            if (typeof value === "number") {
              cls = value > 0 ? "positive" : value < 0 ? "negative" : "";
            }
            body += `<td class="${cls}">${value}</td>`;
          });
          body += "</tr>";
        });
        body += "</tbody>";

        table.innerHTML = header + body;
      } catch (err) {
        expiryEl.innerText = "--";
        spotEl.innerText = "--";
        table.innerHTML = `<tr><td colspan="10" class="text-danger">${err.message}</td></tr>`;
      }
    }

    // Auto fetch when page loads
    fetchOptionChain();
  </script>
{% endblock %}