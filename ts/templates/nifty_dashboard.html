{% extends "layout.html" %}
{% block title %}Nifty Option Chain{% endblock %}

{% block content %}
<div class="container mt-3">
  <h2>ðŸ“Š NIFTY Option Chain Dashboard</h2>

  <div class="row mb-3">
    <div class="col-md-3">
      <button id="fetchNowBtn" class="btn btn-success w-100">Fetch Now (Save)</button>
    </div>
    <div class="col-md-3">
      <label class="form-label">Expiry Date</label>
      <select id="expiry" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Fetch Date</label>
      <select id="fetch" class="form-select"></select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary w-100" onclick="loadData()">Show Data</button>
    </div>
  </div>

  <div id="tableDiv" class="table-responsive mt-4"></div>
</div>

<script>
async function fetchNow() {
  const btn = document.getElementById('fetchNowBtn');
  btn.disabled = true;
  btn.innerText = 'Fetching...';
  try {
    const res = await fetch('/nifty/fetch-nifty/');
    const data = await res.json();
    alert(data.message || 'Fetched');
    loadExpiries();
  } catch (e) {
    alert('Fetch failed: ' + e);
  } finally {
    btn.disabled = false;
    btn.innerText = 'Fetch Now (Save)';
  }
}

async function loadExpiries() {
  let res = await fetch('/nifty/api/expiries/');
  let data = await res.json();
  let expirySelect = document.getElementById('expiry');
  expirySelect.innerHTML = '<option value="">Select Expiry</option>';
  data.expiries.forEach(e => {
    expirySelect.innerHTML += `<option value="${e}">${e}</option>`;
  });
  // clear fetch dates & table
  document.getElementById('fetch').innerHTML = '<option value="">Select Fetch Date</option>';
  document.getElementById('tableDiv').innerHTML = '';
}

async function loadFetchDates() {
  let expiry = document.getElementById('expiry').value;
  let fetchSelect = document.getElementById('fetch');
  if (!expiry) return;
  let res = await fetch(`/nifty/api/fetch-dates/${expiry}/`);
  let data = await res.json();
  fetchSelect.innerHTML = '<option value="">Select Fetch Date</option>';
  data.fetch_dates.forEach(f => {
    fetchSelect.innerHTML += `<option value="${f}">${f}</option>`;
  });
}

async function loadData() {
  let expiry = document.getElementById('expiry').value;
  let fetchDate = document.getElementById('fetch').value;
  if (!expiry || !fetchDate) return alert('Select expiry & fetch date!');
  
  let res = await fetch(`/nifty/api/nifty-data/?expiry_date=${expiry}&fetch_date=${fetchDate}`);
  let data = await res.json();

  if (!data.rows || !data.rows.length) {
    document.getElementById('tableDiv').innerHTML = "<p class='text-danger text-center'>No data available!</p>";
    return;
  }

  let html = `
  <h4 class="mt-3 text-center text-primary">Expiry: ${data.expiry} | Fetch Date: ${data.fetch_date}</h4>
  <table class="table table-bordered table-striped table-sm mt-3">
    <thead class="table-primary">
      <tr>
        <th>#</th>
        <th>Strike</th>
        <th>Option</th>
        <th>Open</th>
        <th>High</th>
        <th>Low</th>
        <th>Close</th>
        <th>LTP</th>
        <th>Volume</th>
        <th>Value</th>
        <th>OI</th>
        <th>IV</th>
      </tr>
    </thead>
    <tbody>
  `;

  data.rows.forEach((r, idx) => {
    html += `<tr>
      <td>${idx+1}</td>
      <td>${r.strike}</td>
      <td>${r.option}</td>
      <td>${r.open}</td>
      <td>${r.high}</td>
      <td>${r.low}</td>
      <td>${r.close}</td>
      <td>${r.ltp}</td>
      <td>${r.volume}</td>
      <td>${r.value}</td>
      <td>${r.oi}</td>
      <td>${r.iv}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('tableDiv').innerHTML = html;
}

document.getElementById('expiry').addEventListener('change', loadFetchDates);
document.getElementById('fetchNowBtn').addEventListener('click', fetchNow);

// initial load
loadExpiries();
</script>
{% endblock %}